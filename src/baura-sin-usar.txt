
// ==============================
// üîß EXTENSI√ìN DE ESQUEMA: subcategor√≠as de negocio
// ==============================
// A√±adimos un nivel intermedio para poder cargar "todos" los tipos de negocios
// sin saturar la tabla Categoria. Los negocios podr√°n apuntar a una Subcategoria.

model Subcategoria {
  id          Int        @id @default(autoincrement())
  nombre      String     @unique
  categoriaId Int
  categoria   Categoria  @relation(fields: [categoriaId], references: [id])
  negocios    Negocio[]
}

// A√±adimos la FK opcional en Negocio ‚Üí Subcategoria
// (col√≥calo en tu modelo Negocio si no lo tienes ya)
// NOTE: si ya tienes migraciones, crea una nueva con prisma migrate

// --- PATCH EN Negocio ---
//  subcategoriaId Int?
//  subcategoria   Subcategoria? @relation(fields: [subcategoriaId], references: [id])

// ==============================
// üì¶ SEED: Categor√≠as y Subcategor√≠as masivas
// ==============================
// Archivo sugerido: prisma/seed.ts
// Ejecuta con: npx prisma db seed (configura package.json -> "prisma": { "seed": "ts-node prisma/seed.ts" })

/*
  package.json (ejemplo):
  {
    "devDependencies": { "ts-node": "^10", "typescript": "^5" },
    "prisma": { "seed": "ts-node prisma/seed.ts" }
  }
*/

// prisma/seed.ts
// -------------------------------------------------
// Este seed crea ~30 categor√≠as y >180 subcategor√≠as comunes en una gran ciudad.
// Ajusta libremente; evita duplicados por unique(nombre).

/*
import { PrismaClient } from '@prisma/client'
const prisma = new PrismaClient()

const data: Array<{ nombre: string; subcategorias: string[] }> = [
  {
    nombre: 'Restauraci√≥n y Alimentaci√≥n',
    subcategorias: [
      'Restaurante tradicional', 'Bar de tapas', 'Cervecer√≠a', 'Cafeter√≠a', 'Panader√≠a', 'Pasteler√≠a', 'Helader√≠a',
      'Hamburgueser√≠a', 'Pizzer√≠a', 'Kebab / D√∂ner', 'Wok / Asi√°tico r√°pido', 'Gastrobar', 'Asador / Parrilla',
      'Comida para llevar', 'Comida vegana', 'Comida vegetariana', 'Restaurante italiano', 'Restaurante japon√©s',
      'Restaurante chino', 'Restaurante mexicano', 'Restaurante peruano', 'Restaurante colombiano', 'Restaurante brasile√±o',
      'Sushi bar', 'Taper√≠a', 'Food truck', 'Vinoteca', 'Bodega con degustaci√≥n', 'Churrer√≠a'
    ]
  },
  {
    nombre: 'Salud y Bienestar',
    subcategorias: [
      'Cl√≠nica dental', '√ìptica', 'Farmacia', 'Parafarmacia', 'Psicolog√≠a', 'Fisioterapia', 'Nutrici√≥n',
      'Podolog√≠a', 'Logopedia', 'Psquiatr√≠a', 'Centro m√©dico', 'Rehabilitaci√≥n', 'Acupuntura', 'Quiromasaje',
      'Centro de fertilidad', 'Veterinaria', 'Centro m√©dico est√©tico'
    ]
  },
  {
    nombre: 'Belleza y Cuidado personal',
    subcategorias: [
      'Peluquer√≠a', 'Barber√≠a', 'Centro de est√©tica', 'Manicura y pedicura', 'Depilaci√≥n l√°ser', 'Depilaci√≥n cera',
      'Maquillaje profesional', 'Centro de bronceado', 'Spa urbano', 'Micropigmentaci√≥n', 'Extensiones de pesta√±as'
    ]
  },
  {
    nombre: 'Moda y Complementos',
    subcategorias: [
      'Tienda de ropa hombre', 'Tienda de ropa mujer', 'Infantil / beb√©', 'Boutique', 'Zapater√≠a', 'Deportiva',
      'Vintage / segunda mano', 'Ropa de trabajo', 'Trajes de boda / fiesta', 'Lencer√≠a', 'Sombrerer√≠a', 'Arreglos de ropa'
    ]
  },
  {
    nombre: 'Automoci√≥n y Transporte',
    subcategorias: [
      'Taller mec√°nico', 'Chapa y pintura', 'Taller de motos', 'Lavado de veh√≠culos', 'Recambios', 'ITV / pre-ITV',
      'Neum√°ticos', 'Gr√∫as', 'Alquiler de coches', 'Alquiler de furgonetas', 'Parking privado', 'Taller el√©ctrico'
    ]
  },
  {
    nombre: 'Hogar y Decoraci√≥n',
    subcategorias: [
      'Muebles', 'Decoraci√≥n', 'Iluminaci√≥n', 'Menaje', 'Textil hogar', 'Bricolaje / DIY', 'Electrodom√©sticos',
      'Cortinas y estores', 'Colchoner√≠a', 'Tienda de cocinas', 'Reformas integrales', 'Puertas y armarios'
    ]
  },
  {
    nombre: 'Tecnolog√≠a y Comunicaciones',
    subcategorias: [
      'Inform√°tica', 'Reparaci√≥n de m√≥viles', 'Telefon√≠a', 'Fotograf√≠a', 'Impresi√≥n 3D', 'Videovigilancia',
      'Tiendas de videojuegos', 'Servicio t√©cnico electr√≥nica', 'Ciber caf√©'
    ]
  },
  {
    nombre: 'Cultura y Ocio',
    subcategorias: [
      'Librer√≠a', 'Papeler√≠a', 'Tienda de c√≥mics', 'Tienda de m√∫sica y vinilos', 'Galer√≠a de arte', 'Centro cultural',
      'Sala de conciertos', 'Cine', 'Teatro', 'Escape room', 'Sala de exposiciones', 'Estudio de grabaci√≥n'
    ]
  },
  {
    nombre: 'Educaci√≥n y Formaci√≥n',
    subcategorias: [
      'Academia de idiomas', 'Refuerzo escolar', 'Oposiciones', 'Autoescuela', 'Escuela de m√∫sica', 'Escuela de danza',
      'Centro de formaci√≥n profesional', 'Guarder√≠a / infantil', 'Clases particulares'
    ]
  },
  {
    nombre: 'Mascotas',
    subcategorias: [
      'Tienda de animales', 'Piensos y accesorios', 'Peluquer√≠a canina', 'Adiestramiento', 'Residencia / guarder√≠a', 'Cl√≠nica veterinaria'
    ]
  },
  {
    nombre: 'Servicios Profesionales',
    subcategorias: [
      'Asesor√≠a fiscal', 'Gestor√≠a', 'Abogac√≠a', 'Arquitectura', 'Ingenier√≠a', 'Consultor√≠a', 'Notar√≠a', 'Recursos humanos',
      'Agencia de seguros', 'Agencia de viajes', 'Traducci√≥n e interpretaci√≥n'
    ]
  },
  {
    nombre: 'Deportes y Actividad F√≠sica',
    subcategorias: [
      'Gimnasio', 'Crossfit', 'Yoga', 'Pilates', 'Artes marciales', 'Boxeo', 'Centro de escalada', 'P√°del', 'Tenis',
      'Club de running', 'Nataci√≥n', 'Tienda de material deportivo'
    ]
  },
  {
    nombre: 'Alimentaci√≥n al por menor',
    subcategorias: [
      'Supermercado', 'Ultramarinos', 'Fruter√≠a', 'Carnicer√≠a', 'Pescader√≠a', 'Charcuter√≠a', 'Gourmet / delicatessen',
      'Ecol√≥gico / bio', 'Congelados', 'Bodega / vinoteca', 'Tienda de cerveza artesanal'
    ]
  },
  {
    nombre: 'Servicios T√©cnicos y Reparaci√≥n',
    subcategorias: [
      'Cerrajer√≠a', 'Fontaner√≠a', 'Electricidad', 'Alba√±iler√≠a', 'Carpinter√≠a', 'Cristaler√≠a', 'Pintura y decoraci√≥n',
      'Tapicer√≠a', 'Reparaci√≥n de electrodom√©sticos', 'Llaves y duplicados', 'Mudanzas', 'Instalaci√≥n de climatizaci√≥n'
    ]
  },
  {
    nombre: 'Ocio Nocturno',
    subcategorias: [
      'Discoteca', 'Pub', 'Cocteler√≠a', 'Bar musical', 'Karaoke', 'Sala de fiestas'
    ]
  },
  {
    nombre: 'Turismo y Alojamiento',
    subcategorias: [
      'Hotel', 'Hostal', 'Apartamento tur√≠stico', 'Casa rural', 'Albergue', 'Tour operador local', 'Gu√≠a tur√≠stico', 'Oficina de turismo'
    ]
  },
  {
    nombre: 'Transporte Urbano y Mensajer√≠a',
    subcategorias: [
      'Mensajer√≠a local', 'Reparto a domicilio', 'Taxis / VTC', 'Alquiler de bicis / patinetes', 'Parking bicicletas', 'Moto sharing'
    ]
  },
  {
    nombre: 'Finanzas y Banca',
    subcategorias: [
      'Sucursal bancaria', 'Cajero / ATM', 'Casa de cambio', 'Fintech local', 'Corredur√≠a de seguros'
    ]
  },
  {
    nombre: 'Eventos y Celebraciones',
    subcategorias: [
      'Organizaci√≥n de eventos', 'Catering', 'Alquiler de sonido e iluminaci√≥n', 'Fotomat√≥n', 'Flores para eventos',
      'Trajes de ceremonia', 'Wedding planner', 'Sal√≥n de celebraciones'
    ]
  },
  {
    nombre: 'Foto y Audiovisual',
    subcategorias: [
      'Estudio fotogr√°fico', 'Vide√≥grafo', 'Alquiler de material', 'Revelado e impresi√≥n', 'Drones / aerial'
    ]
  },
  {
    nombre: 'Arte y Artesan√≠a',
    subcategorias: [
      'Taller de cer√°mica', 'Taller de joyer√≠a', 'Marqueter√≠a', 'Luther√≠a', 'Artesan√≠a textil', 'Serigraf√≠a / estampaci√≥n'
    ]
  },
  {
    nombre: 'Infantil y Familia',
    subcategorias: [
      'Parque infantil', 'Ludoteca', 'Tienda de juguetes', 'Ropa infantil', 'Animaci√≥n infantil', 'Fotograf√≠a infantil'
    ]
  },
  {
    nombre: 'Mayores y Cuidados',
    subcategorias: [
      'Centro de d√≠a', 'Ayuda a domicilio', 'Ortopedia', 'Rehabilitaci√≥n geri√°trica', 'Teleasistencia'
    ]
  },
  {
    nombre: 'Mercados y Agricultura',
    subcategorias: [
      'Mercado municipal', 'Plaza de abastos', 'Venta de proximidad', 'Huertos urbanos', 'Cooperativa agr√≠cola'
    ]
  },
  {
    nombre: 'Energ√≠a y Sostenibilidad',
    subcategorias: [
      'Instalaci√≥n fotovoltaica', 'Comunidad energ√©tica', 'Auditor√≠a energ√©tica', 'Movilidad el√©ctrica', 'Reciclaje y residuos'
    ]
  },
  {
    nombre: 'Coworking y Negocios',
    subcategorias: [
      'Coworking', 'Oficinas compartidas', 'Aceleradora', 'Incubadora', 'Salas de reuniones'
    ]
  },
  {
    nombre: 'Servicios Dom√©sticos',
    subcategorias: [
      'Limpieza', 'Plancha a domicilio', 'Cuidado de ni√±os', 'Cuidado de mascotas', 'Manitas / handyman'
    ]
  },
  {
    nombre: 'Juegos y Aficiones',
    subcategorias: [
      'Tienda de juegos de mesa', 'Tienda de hobbies', 'Modelismo', 'Comics y manga', 'Cartas coleccionables', 'Sala gaming / eSports'
    ]
  },
  {
    nombre: 'Especializados / Otros',
    subcategorias: [
      'Antig√ºedades', 'Numism√°tica y filatelia', 'Sex shop', 'Tienda de disfraces', 'Rotulaci√≥n e impresi√≥n', 'Mercer√≠a'
    ]
  },
]


async function main() {
  for (const cat of data) {
    const categoria = await prisma.categoria.upsert({
      where: { nombre: cat.nombre },
      update: {},
      create: { nombre: cat.nombre },
    })
    for (const s of cat.subcategorias) {
      await prisma.subcategoria.upsert({
        where: { nombre: s },
        update: { categoriaId: categoria.id },
        create: { nombre: s, categoriaId: categoria.id },
      })
    }
  }
}

main()
  .then(() => prisma.$disconnect())
  .catch(async (e) => { console.error(e); await prisma.$disconnect(); process.exit(1) })
*/


// ==============================
// üå∏ Econom√≠a de P√©talos (versi√≥n simple, sin rifas ni superlikes)
// ==============================
// Reglas:
//  - Publicar una rese√±a ‚Üí +5 p√©talos al autor
//  - Recibir una rese√±a en tu negocio ‚Üí +5 p√©talos al due√±o del negocio
//  - Dar like a una rese√±a ‚Üí ‚àí1 p√©talo (se quema). Si saldo < 1, no puedes dar like.
//  - Objetivo: ciclo simple de ganar (crear) y gastar (reaccionar).

// ---- PATCH PRISMA ----
// A√±ade saldo + ledger de transacciones
model PetaloTx {
  id        Int      @id @default(autoincrement())
  usuarioId Int
  delta     Int      // + gana, - gasta
  motivo    String   // 'resena_autor','resena_negocio','like'
  refTipo   String?  // 'Resena','Post'
  refId     Int?
  creadoEn  DateTime @default(now())
  usuario   Usuario  @relation(fields: [usuarioId], references: [id])

  @@index([usuarioId, creadoEn])
  @@index([refTipo, refId])
}

// PATCH en Usuario: a√±ade campos si no existen
// petalosSaldo Int      @default(0)
// petalosTx    PetaloTx[]

// ------------------------------
// üß† Servicios (NestJS/Prisma) ‚Äì implementaci√≥n m√≠nima
// ------------------------------
/*
// petals.service.ts
import { PrismaClient } from '@prisma/client'
const prisma = new PrismaClient()

export class PetalsService {
  async awardOnReview(resenaId: number) {
    return prisma.$transaction(async (tx) => {
      const resena = await tx.resena.findUnique({
        where: { id: resenaId },
        include: { negocio: { select: { due√±oId: true } }, usuario: { select: { id: true } } },
      })
      if (!resena) throw new Error('Rese√±a no encontrada')

      // +5 al autor
      await tx.petaloTx.create({ data: { usuarioId: resena.usuarioId, delta: 5, motivo: 'resena_autor', refTipo: 'Resena', refId: resena.id } })
      await tx.usuario.update({ where: { id: resena.usuarioId }, data: { petalosSaldo: { increment: 5 } } })

      // +5 al due√±o del negocio (si existe y no es la misma persona)
      const duenoId = resena.negocio?.due√±oId
      if (duenoId && duenoId !== resena.usuarioId) {
        await tx.petaloTx.create({ data: { usuarioId: duenoId, delta: 5, motivo: 'resena_negocio', refTipo: 'Resena', refId: resena.id } })
        await tx.usuario.update({ where: { id: duenoId }, data: { petalosSaldo: { increment: 5 } } })
      }

      return { ok: true }
    })
  }

  async likeResena(usuarioId: number, postId: number) {
    return prisma.$transaction(async (tx) => {
      const u = await tx.usuario.findUnique({ where: { id: usuarioId }, select: { petalosSaldo: true } })
      if (!u || u.petalosSaldo < 1) throw new Error('Saldo insuficiente de p√©talos')

      // registrar like normal en tu modelo Like
      await tx.like.create({ data: { usuarioId, postId, tipo: 'like' } })

      // cobrar 1 p√©talo (burn)
      await tx.petaloTx.create({ data: { usuarioId, delta: -1, motivo: 'like', refTipo: 'Post', refId: postId } })
      await tx.usuario.update({ where: { id: usuarioId }, data: { petalosSaldo: { decrement: 1 } } })

      return { ok: true }
    })
  }
}
*/

// ------------------------------
// ‚úÖ Anti-abuso m√≠nimos (opcional)
// ------------------------------
// - Evitar que el due√±o se auto-premie rese√±ando su propio negocio: ya lo impedimos si due√±oId === autorId.
// - (Opcional) M√°x. 2 rese√±as recompensadas por autor/d√≠a.
// - (Opcional) Rese√±as de calidad: longitud m√≠nima o compra/reserva asociada.


# API v1 ‚Äì Endpoints propuestos (cobertura total)
_Base path_: `/api/v1`  ¬∑ Auth via Bearer JWT  ¬∑ Paginaci√≥n: `?page=1&limit=20`  ¬∑ Filtros comunes: `?q=texto&sort=-creadoEn`

## 0) Salud
- `GET /health` ‚Üí estado del servicio

## 1) Auth
- `POST /auth/register` ‚Üí {nombre, nickname, email, password}
- `POST /auth/login` ‚Üí {email, password}
- `POST /auth/refresh` ‚Üí refresh token
- `POST /auth/logout`
- `POST /auth/forgot-password` ‚Üí {email}
- `POST /auth/reset-password` ‚Üí {token, newPassword}
- `POST /auth/verify-email` ‚Üí {token}

## 2) Usuario
- `GET  /me` ‚Üí perfil propio + saldos (p√©talos)
- `PATCH /me` ‚Üí actualizar {nombre, bio, foto}
- `GET  /me/petalos/balance`
- `GET  /me/petalos/tx` ‚Üí ledger (paginado)
- `GET  /usuarios/:id` ‚Üí perfil p√∫blico
- `GET  /usuarios` ‚Üí listado/b√∫squeda
- `PATCH /usuarios/:id` (admin)
- `DELETE /usuarios/:id` (admin)

## 3) Categor√≠as & Subcategor√≠as
- `GET  /categorias`
- `POST /categorias` (admin)
- `PATCH /categorias/:id` (admin)
- `DELETE /categorias/:id` (admin)
- `GET  /subcategorias?categoriaId=`
- `POST /subcategorias` (admin)
- `PATCH /subcategorias/:id` (admin)
- `DELETE /subcategorias/:id` (admin)

## 4) Negocios
- `GET  /negocios` ‚Üí filtros: `?categoriaId&subcategoriaId&q`
- `POST /negocios` (due√±o) ‚Üí crear negocio (due√±oId = me)
- `GET  /negocios/:id`
- `PATCH /negocios/:id` (due√±o/admin)
- `DELETE /negocios/:id` (due√±o/admin)
- `PATCH /negocios/:id/config-horario` ‚Üí {horario, intervaloReserva}
- `GET  /negocios/:id/horario`
- `GET  /negocios/:id/posts`
- `GET  /negocios/:id/resenas`
- `GET  /negocios/:id/reservas?desde=&hasta=`
- `GET  /negocios/:id/availability?date=YYYY-MM-DD` ‚Üí genera slots por `intervaloReserva`

## 5) Productos
- `GET  /negocios/:id/productos`
- `POST /negocios/:id/productos` (due√±o)
- `GET  /productos/:id`
- `PATCH /productos/:id` (due√±o)
- `DELETE /productos/:id` (due√±o)

## 6) Promociones
- `GET  /negocios/:id/promociones`
- `POST /negocios/:id/promociones` (due√±o)
- `GET  /promociones/:id`
- `PATCH /promociones/:id` (due√±o)
- `DELETE /promociones/:id` (due√±o)

## 7) Posts (unificado)
- `GET  /posts?tipo=&usuarioId=&negocioId=`
- `GET  /posts/:id`
- `DELETE /posts/:id` (autor/admin)

## 8) Rese√±as (como tipo de Post + tabla Resena)
- `POST /negocios/:id/resenas` ‚Üí {contenido, puntuacion, selloNenufar}
  - **Side-effect**: crea `Post` tipo rese√±a y **paga p√©talos** (+5 autor, +5 due√±o)
- `GET  /resenas/:id`
- `PATCH /resenas/:id` (autor)
- `DELETE /resenas/:id` (autor/admin)

## 9) Comentarios
- `GET  /posts/:id/comentarios`
- `POST /posts/:id/comentarios` ‚Üí {contenido}
- `PATCH /comentarios/:id` (autor)
- `DELETE /comentarios/:id` (autor/admin)

## 10) Likes
- `POST   /posts/:id/like` ‚Üí consume **1 p√©talo** (si saldo‚â•1), crea `Like(tipo='like')`
- `DELETE /posts/:id/like` ‚Üí quita like (no reembolsa p√©talos)
- `GET    /posts/:id/likes` ‚Üí conteo y listado

## 11) Reservas (horario gen√©rico)
- `GET  /negocios/:id/availability?date=YYYY-MM-DD` ‚Üí slots generados
- `POST /negocios/:id/reservas` ‚Üí {fecha, nota}
- `GET  /reservas/:id`
- `DELETE /reservas/:id` (usuario/due√±o)
- `GET  /me/reservas`

## 12) Mesas (m√≥dulo opcional)
- `GET  /negocios/:id/mesas`
- `POST /negocios/:id/mesas` (due√±o) ‚Üí {nombre, capacidad, ubicacion}
- `PATCH /mesas/:id` (due√±o)
- `DELETE /mesas/:id` (due√±o)
- `GET  /negocios/:id/mesas/availability?date=YYYY-MM-DD&desde=HH:mm&hasta=HH:mm`
- `POST /mesas/:id/reservas` ‚Üí {usuarioId?, fecha, horaInicio, horaFin, nota}
- `GET  /reservas-mesa/:id`
- `DELETE /reservas-mesa/:id` (usuario/due√±o)

## 13) Pedidos / Compras / Pagos
- **Carrito/Pedido**
  - `POST /negocios/:id/pedidos` ‚Üí crea pedido vac√≠o
  - `GET  /pedidos/:id`
  - `POST /pedidos/:id/items` ‚Üí {productoId, cantidad}
  - `PATCH /pedidos/:id/items/:itemId` ‚Üí {cantidad}
  - `DELETE /pedidos/:id/items/:itemId`
  - `PATCH /pedidos/:id` ‚Üí {estado}
- **Compra** (por usuario que participa)
  - `POST /pedidos/:id/compras` ‚Üí {usuarioId, total}
  - `GET  /compras/:id`
  - `GET  /me/compras`
- **Pago**
  - `POST /compras/:id/pagos` ‚Üí {metodoPago, cantidad}
  - `GET  /pagos/:id`
  - `GET  /me/pagos`

## 14) Logros
- `GET  /logros` ‚Üí filtros: `?tipo=&objetivoTipo=&objetivoId=`
- `POST /logros` (admin)
- `PATCH /logros/:id` (admin)
- `DELETE /logros/:id` (admin)
- `GET  /me/logros` ‚Üí progreso
- `POST /logros/:id/grant` (admin) ‚Üí concede manualmente a un usuario {usuarioId}

## 15) P√©talos (econom√≠a simple)
- `GET  /me/petalos/balance`
- `GET  /me/petalos/tx` ‚Üí historial
- (Autom√°tico) **on rese√±a creada** ‚Üí `+5 autor`, `+5 due√±o negocio`
- (Autom√°tico) **on like** ‚Üí `‚àí1` del que da like (si saldo<1 ‚Üí 409)
- `POST /admin/petalos/ajustar` (admin) ‚Üí {usuarioId, delta, motivo}
- `GET  /economia/config` (admin)
- `PATCH /economia/config` (admin) ‚Üí ajustar reglas si hiciera falta

## 16) B√∫squeda y Feed
- `GET /search` ‚Üí busca en negocios/productos/posts (`?q=&tipo=`)
- `GET /feed` ‚Üí timeline de posts (novedades, rese√±as, promos)

## 17) Admin (seguridad/gesti√≥n)
- `GET  /admin/metrics` ‚Üí conteos, M2 de p√©talos, DAU, etc.
- `PATCH /admin/usuarios/:id/ban`
- `GET  /admin/auditoria/petalos` ‚Üí agregados de `PetaloTx`

---
### Notas de implementaci√≥n
- **Eventos autom√°ticos**: pagar p√©talos al crear rese√±a y cobrar al dar like se hacen en **transacciones** de los endpoints correspondientes.
- **Errores**: usar 400 (validaci√≥n), 401/403 (auth), 404 (no existe), 409 (conflicto: saldo < 1 para like), 422 (regla negocio), 500 (server).
- **Idempotencia**: pagos con `Idempotency-Key` en cabecera.
- **Rate limiting**: `/auth/*` y `/posts/:id/like`.
- **Paginaci√≥n**: `X-Total-Count` en cabecera.
